---
config:
  theme: dark
---
%% Sequence Diagram - Home Assistant conversation routed through Lucia
%% Audience: Backend engineers | Purpose: Describe runtime choreography for request handling
sequenceDiagram
  autonumber
  actor Homeowner as Homeowner
  participant Plugin as Lucia Conversation Plugin
  participant HAAPI as Home Assistant API Layer
  participant LuciaAPI as Lucia API Service
  participant Orchestrator as Semantic Kernel Orchestrator
  participant Agent as Specialized Agent (e.g., LightAgent)
  participant LLM as Optional LLM Provider
  participant Devices as Home Assistant Devices & Automations

  Homeowner->>Plugin: Issue natural language request
  Plugin->>HAAPI: Submit conversation payload
  HAAPI->>LuciaAPI: HTTP POST /agents/execute
  LuciaAPI->>Orchestrator: Build plan & select agent(s)
  Orchestrator->>Agent: Invoke capability via A2A JSON-RPC
  Agent-->>Orchestrator: Proposed action & rationale
  Agent->>LLM: (Optional) Ask for reasoning / summarization
  LLM-->>Agent: Resulting intent refinement
  Orchestrator->>HAAPI: Send concrete device command(s)
  HAAPI->>Devices: Apply state changes / execute automation
  Devices-->>HAAPI: Report updated state
  HAAPI-->>Plugin: Structured response payload
  Plugin-->>Homeowner: Confirm outcome via TTS/UI
