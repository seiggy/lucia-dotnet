# Lucia Agent Host - Docker Compose Configuration
#
# Services:
#   - lucia: Agent Host API (main application)
#   - redis: Task persistence and session state
#   - mongo: Trace capture and configuration storage
#
# Features:
#   - Health checks for automatic restart
#   - Volume mounts for persistent data
#   - Environment-based configuration
#   - Network isolation with shared network
#   - Resource limits for stability
#
# Usage:
#   # Start all services
#   docker-compose up -d
#
#   # View logs
#   docker-compose logs -f lucia
#
#   # Stop services
#   docker-compose down
#
#   # Remove volumes (deletes persisted data)
#   docker-compose down -v

services:

  # ========================================================================
  # Redis Service - Task Persistence and Session State
  # ========================================================================
  redis:
    # Use official Redis 8.2 image with alpine for minimal size
    image: redis:8.2-alpine
    
    container_name: lucia-redis
    
    # Network configuration
    networks:
      - lucia-network
    
    # Port exposure (only on localhost for security)
    ports:
      - "127.0.0.1:6379:6379"
    
    # Command to enable persistence
    # AOF (Append-Only File) enabled for durability
    # maxmemory policy for automatic eviction
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --loglevel notice
    
    # Volume for persistent data storage
    volumes:
      - redis-data:/data
    
    # Health check for automatic restart
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "PING"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    
    # Restart policy
    restart: unless-stopped
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "redis"
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Read-only filesystem except for /data
    read_only: true
    tmpfs:
      - /tmp


  # ========================================================================
  # MongoDB Service - Trace Capture and Configuration Storage
  # ========================================================================
  mongo:
    # Use official MongoDB 8.0 image
    image: mongo:8.0
    
    container_name: lucia-mongo
    
    # Network configuration
    networks:
      - lucia-network
    
    # Port exposure (only on localhost for security)
    ports:
      - "127.0.0.1:27017:27017"
    
    # Volume for persistent data storage
    volumes:
      - mongo-data:/data/db
    
    # Health check for automatic restart
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.runCommand('ping').ok"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    
    # Restart policy
    restart: unless-stopped
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "mongo"
    
    # Security options
    security_opt:
      - no-new-privileges:true


  # ========================================================================
  # A2A Host Base Image Build (build-only, not a running service)
  # Agent-specific images layer their plugins on top of this.
  # ========================================================================
  a2ahost-base:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.a2ahost
      args:
        BUILD_CONFIGURATION: Release
    image: lucia-a2ahost:latest
    # This service exists only to produce the base image; it exits immediately.
    entrypoint: ["true"]

  # ========================================================================
  # Lucia Agent Host Service - Main Application
  # ========================================================================
  lucia:
    # Build from local Dockerfile
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
      args:
        BUILD_CONFIGURATION: Release
        BUILD_TARGET_FRAMEWORK: net10.0
      cache_from:
        - lucia:latest

    image: lucia:latest

    container_name: lucia

    # Depends on Redis and MongoDB being healthy
    depends_on:
      redis:
        condition: service_healthy
      mongo:
        condition: service_healthy
    
    # Network configuration
    networks:
      - lucia-network
    
    # Port exposure
    ports:
      - "127.0.0.1:5000:8080"  # HTTP API
      - "127.0.0.1:5001:8081"  # HTTPS (disabled in MVP)
    
    # Volume mounts
    volumes:
      # Configuration (read-only)
      - ../../.env:/app/.env:ro
    
    # Environment variables from .env file
    env_file:
      - ../../.env
    
    # Additional environment variables
    environment:
      # ASP.NET Core configuration
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      
      # Connection strings (must be set via .env)
      # - ConnectionStrings__chat-model=Endpoint=...;AccessKey=...;Model=...;Provider=openai
      # - ConnectionStrings__home-assistant=http://homeassistant:8123
      # - ConnectionStrings__redis=redis://redis:6379
      
      # MongoDB connection strings
      - ConnectionStrings__luciatraces=mongodb://lucia-mongo:27017/luciatraces
      - ConnectionStrings__luciaconfig=mongodb://lucia-mongo:27017/luciaconfig
      - ConnectionStrings__luciatasks=mongodb://lucia-mongo:27017/luciatasks
      
      # Logging
      - LUCIA_LOG_LEVEL=Information
      
      # Observability
      - OTEL_ENABLED=true
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317
      
      # .NET Runtime
      - DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=false
      - DOTNET_RUNNING_IN_CONTAINER=true
      - COMPlus_EnableDiagnostics=0
    
    # Health check for automatic restart
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '1'
          memory: 512M
    
    # Restart policy
    restart: unless-stopped
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"
        tag: "lucia"
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Read-only filesystem for security
    read_only: true
    tmpfs:
      - /tmp
      - /app/bin
    
    # Capability dropping for reduced attack surface
    cap_drop:
      - NET_RAW
      - SYS_PTRACE
      - SYS_ADMIN


  # ========================================================================
  # Optional: Home Assistant Service (for local testing)
  # ========================================================================
  # Uncomment to run Home Assistant in same Docker Compose
  # homeassistant:
  #   image: homeassistant/home-assistant:latest
  #   container_name: lucia-homeassistant
  #   networks:
  #     - lucia-network
  #   ports:
  #     - "127.0.0.1:8123:8123"
  #   environment:
  #     - TZ=UTC
  #   volumes:
  #     - homeassistant-data:/config
  #   restart: unless-stopped


  # ========================================================================
  # Music Agent - A2A Plugin Host (Music Playback)
  # ========================================================================
  music-agent:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.music-agent
      args:
        BUILD_CONFIGURATION: Release
        A2AHOST_IMAGE: lucia-a2ahost:latest

    image: lucia-music-agent:latest

    container_name: lucia-music-agent

    depends_on:
      a2ahost-base:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
      mongo:
        condition: service_healthy

    networks:
      - lucia-network

    ports:
      - "127.0.0.1:5010:8080"

    env_file:
      - ../../.env

    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__redis=lucia-redis:6379
      - ConnectionStrings__luciatraces=mongodb://lucia-mongo:27017/luciatraces
      - ConnectionStrings__luciaconfig=mongodb://lucia-mongo:27017/luciaconfig
      - ConnectionStrings__luciatasks=mongodb://lucia-mongo:27017/luciatasks
      - DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=false
      - DOTNET_RUNNING_IN_CONTAINER=true
      - COMPlus_EnableDiagnostics=0

    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "music-agent"

    security_opt:
      - no-new-privileges:true

    read_only: true
    tmpfs:
      - /tmp


  # ========================================================================
  # Timer Agent - A2A Plugin Host (Timers & Announcements)
  # ========================================================================
  timer-agent:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile.timer-agent
      args:
        BUILD_CONFIGURATION: Release
        A2AHOST_IMAGE: lucia-a2ahost:latest

    image: lucia-timer-agent:latest

    container_name: lucia-timer-agent

    depends_on:
      a2ahost-base:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
      mongo:
        condition: service_healthy

    networks:
      - lucia-network

    ports:
      - "127.0.0.1:5011:8080"

    env_file:
      - ../../.env

    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__redis=lucia-redis:6379
      - ConnectionStrings__luciatraces=mongodb://lucia-mongo:27017/luciatraces
      - ConnectionStrings__luciaconfig=mongodb://lucia-mongo:27017/luciaconfig
      - ConnectionStrings__luciatasks=mongodb://lucia-mongo:27017/luciatasks
      - DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=false
      - DOTNET_RUNNING_IN_CONTAINER=true
      - COMPlus_EnableDiagnostics=0

    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "timer-agent"

    security_opt:
      - no-new-privileges:true

    read_only: true
    tmpfs:
      - /tmp


# ============================================================================
# Networks
# ============================================================================
networks:
  lucia-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16


# ============================================================================
# Volumes
# ============================================================================
volumes:
  # Redis persistent data
  redis-data:
    driver: local
  
  # MongoDB persistent data
  mongo-data:
    driver: local
  
  # Uncomment for Home Assistant persistent data
  # homeassistant-data:
  #   driver: local

